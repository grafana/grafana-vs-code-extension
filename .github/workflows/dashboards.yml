name: Update dashboards

on:
  push:
    branches:
      - master
    paths:
      - dashboards/**.json

jobs:
  update-dashboards:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Get changed dashboards
        id: changed-dashboards
        uses: tj-actions/changed-files@v355
        with:
          files: dashboards/**.json

      - name: Update changed dashboards in Grafana
        if: steps.changed-files-specific.outputs.any_changed == 'true'
        run: |
          tmp=$(mktemp)
          for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
            uid=$(jq -r '.uid' $file)
            info=$(curl -H "Authorization: Bearer $GRAFANA_API_TOKEN" https://guicaulada.grafana.net/api/dashboards/uid/$uid)
            folderUid=$(echo $info | jq -r '.meta.folderUid')
            currentVersion=$(echo $info | jq -r '.meta.version')
            newVersion=$((currentVersion + 1))
            jq --argjson v $newVersion '.version = $v' $file > $tmp && mv $tmp $file
            curl -X POST https://reqbin.com/echo/post/json -H "Authorization: Bearer $GRAFANA_API_TOKEN" -d '{"dashboard":"$(cat $file)","folderUid":"$folderUid","overwrite":true,"message":"$COMMIT_MESSAGE"}'
          done
        env:
          GRAFANA_API_TOKEN: ${{ secrets.GRAFANA_API_TOKEN }}
          COMMIT_MESSAGE: ${{ github.event.head_commit.message }}
      